#!/bin/bash
#
# borgctl â€“ A Borg backup management script with encryption, compression, and additional commands.
#
# Commands: init, backup, prune, mount, extract, check, log, list, diff, size
# Run 'borgctl --help' for more information.
#

set -o errexit
set -o nounset
set -o pipefail

# Determine script location for finding libraries
SCRIPT_PATH="$(realpath "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

# Support both development (in-tree) and installed locations
if [ -d "$SCRIPT_DIR/lib" ]; then
    LIB_DIR="$SCRIPT_DIR/lib"
    LIBEXEC_DIR="$SCRIPT_DIR/libexec/borgctl"
else
    # Installed location: assume PREFIX/bin/borgctl -> PREFIX/lib, PREFIX/libexec
    PREFIX_DIR="$(dirname "$SCRIPT_DIR")"
    LIB_DIR="$PREFIX_DIR/lib/borgctl"
    LIBEXEC_DIR="$PREFIX_DIR/libexec/borgctl"
fi

# Source common utilities
source "$LIB_DIR/common.sh"

# Use BORG_BACKUP_ROOT if defined; otherwise default to "$HOME/.borg_backups"
if [ -z "${BORG_BACKUP_ROOT:-}" ]; then
    BORG_BACKUP_ROOT="$HOME/.borg_backups"
fi

usage() {
    cat <<'EOF'
usage: borgctl [--dry-run] [--force-full] <command> ...

borgctl - Deduplicated Backups with Borg

Commands:
  init [<path>]
      Initialize a Borg backup repository for <path> (or the current directory if not provided).
      This creates a .borgbackup configuration file and initializes the repository with encryption (repokey).

  backup [--dry-run] [--force-full]
      Create a new backup archive for the repository defined in the current directory (or its nearest parent).
      Archives are created using compression (lz4) and stored in the repository.

  prune [options]
      Purge backup archives.
      Options (mutually exclusive):
        --last X   : Remove the newest X archives.
        --first X  : Remove the oldest X archives.
        --older X  : Remove archives older than X days.
        --newer X  : Remove archives newer than X days.
        --all      : Remove all archives.
      If no option is given, interactive mode is used.

  mount [<mount_point>] [<archive>]
      Mount a backup archive from the repository.

  extract [<destination>] [<archive>]
      Extract a backup archive from the repository to a destination directory.

  check
      Perform an integrity check of the repository using 'borg check'.

  log [<log-index-or-substring>]
      Display a backup log file.

  list
      List all available backup archives in the repository.

  diff
      Compare two archives.
      For the first prompt, if you press Enter without entering a number, the live state (current directory) is used.

  size
      Display the size and info of an archive (using 'borg info').

Common options:
  --dry-run      Simulate actions without making any changes.
  --force-full   Force a full backup (skip incremental linking).
  -h, --help     Show this help message and exit.
EOF
    exit 1
}

# Main command dispatcher
if [ $# -lt 1 ]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    init|backup|prune|mount|extract|check|log|list|diff|size)
        if [ ! -f "$LIBEXEC_DIR/${COMMAND}.sh" ]; then
            echo "Error: Command module for '$COMMAND' not found."
            exit 1
        fi
        source "$LIBEXEC_DIR/${COMMAND}.sh"
        run "$@"
        ;;
    -h|--help)
        usage
        ;;
    *)
        echo "Unknown command: $COMMAND"
        usage
        ;;
esac
